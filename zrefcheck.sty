

\ProvidesExplPackage {zrefcheck} {2021-07-06} {alpha}
  {Flexible cross-references with relative position checks based on zref}

\RequirePackage { zref-user }
\RequirePackage { zref-abspage }
\RequirePackage { zref-savepos }

\RequirePackage { zref-abschap }


% We need 'zref's label commands to issue '\zref@savepos' every time, and not
% just when using the 'savepos' module's commands, because we want every
% 'zlabel' to have proper coordinates.  For this reason, we have to run a call
% to '\zref@savepos' on a "before hook" to '\ZREF@label'.  However, since the
% required information (position on the page of the text to which the label
% refers to) is only known at shipout, we do this call under a dummy (writes
% nothing) call to '\protected@write' to execute '\zref@savepos' right before
% '\ZREF@label's job is done, emulating what this command does in this regard.
% I think this is somewhat institutionalized, see David Carlile's comment at
% https://tex.stackexchange.com/a/98810 regarding the '#2' argument of
% '\protected@write'.  See also the discussion in egreg's answer to the same
% question.  Of course, that is also what '\ZREF@label' itself does and,
% ideally, we'd just place '\zref@savepos' inside it.
\hook_gput_code:nnn { cmd / ZREF@label / before } { zrefcheck }
  {
    \if@filesw
      \begingroup
        \protected@write \@auxout {
          \zref@savepos
        }{}
      \endgroup
    \fi
  }


% Add 'posx'/'posy' to the 'main' list properties, so that the labels created
% with the standard '\zlabel' from the 'user' module carries the position
% information.
\zref@addprop \ZREF@mainlist { posx }
\zref@addprop \ZREF@mainlist { posy }


% Alternate method for determining relative position: the sequence in which
% the labels get shipped out.  Sort of getting the sequence in which the
% labels occur in the .aux file.

\seq_new:N \g__zrefcheck_auxfile_labelseq_seq

% Thanks to Ulrike Fischer: https://tex.stackexchange.com/q/604265
\cs_gset_protected:Npn \zref@newlabel #1#2
  {
    \seq_gput_right:Nn \g__zrefcheck_auxfile_labelseq_seq {#1}
    \@newl@bel {\ZREF@RefPrefix} {#1} {#2}
  }

\prop_new:N \g__zrefcheck_auxfile_labelseq_prop

\cs_new_protected:Npn \__zrefcheck_process_labelseq:
  {
    \prop_gclear:N \g__zrefcheck_auxfile_labelseq_prop
    \group_begin:
      \int_zero:N \l_tmpa_int
      \seq_map_inline:Nn \g__zrefcheck_auxfile_labelseq_seq
        {
          \int_incr:N \l_tmpa_int
          \prop_gput:Nnx \g__zrefcheck_auxfile_labelseq_prop
            { ##1 } { \int_use:N \l_tmpa_int }
        }
    \group_end:
  }

\hook_gput_code:nnn { begindocument } { zrefcheck }
  { \__zrefcheck_process_labelseq: }

\NewDocumentCommand \showalllabels { } {
  \prop_show:N \g__zrefcheck_auxfile_labelseq_prop
}



\int_new:N \g__zrefcheck_id_int

\NewDocumentCommand \zrefcheck { s O { } m O { } +m }
  {
    \int_gincr:N \g__zrefcheck_id_int
    \mode_leave_vertical:
    \group_begin:
      \zref@labelbyprops
        { zrefcheck@ \int_use:N \g__zrefcheck_id_int @beg }
        { default, counter, abspage , abschap , abssec , posx , posy }
      #5 ~ #3
      \clist_map_inline:nn {#4} {~\emph{##1}}
      \zref@labelbyprops
        { zrefcheck@ \int_use:N \g__zrefcheck_id_int @end }
        { default, counter, abspage , abschap , abssec , posx , posy }
    \group_end:
  }